#!/usr/bin/env bash
set -euo pipefail

COMPOSE_DIR="${COMPOSE_DIR:-/media/felix/RAG/AGENTIC}"
OUT_DIR="${OUT_DIR:-/media/felix/RAG/AGENTIC/ops/_shutdown_logs}"
TS="$(date +"%Y%m%d_%H%M%S")"

fail() { echo "❌ STOP FAIL: $*" >&2; exit 1; }
ok()   { echo "✅ $*"; }

cd "$COMPOSE_DIR" || fail "Cannot cd to $COMPOSE_DIR"

echo "=== STOP: AGENTIC stack graceful shutdown ==="
docker compose config >/dev/null || fail "docker compose config invalid"

# Collect a quick snapshot before shutdown (helps diagnose “it was fine yesterday”)
mkdir -p "$OUT_DIR"

echo "Saving pre-shutdown status to $OUT_DIR/$TS ..."
docker compose ps > "$OUT_DIR/${TS}_compose_ps.txt" 2>&1 || true
docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}' > "$OUT_DIR/${TS}_docker_ps.txt" 2>&1 || true
docker compose logs --no-color --tail 200 > "$OUT_DIR/${TS}_compose_tail200.log" 2>&1 || true

# Ask key services to stop cleanly (reduces chances of partial writes)
echo "Requesting graceful stop (docker compose stop -t 30)..."
docker compose stop -t 30 || true

# Sync filesystem buffers (host-side) - cheap and helps with DB durability
echo "Syncing filesystem buffers..."
sync || true

echo "Stopping stack (docker compose down)..."
docker compose down || fail "docker compose down failed"

echo "Checking leftover containers from this compose project..."
# Compose v2 labels containers with com.docker.compose.project
PROJECT="$(docker compose ls --format json 2>/dev/null | head -n 1 | sed -n 's/.*"Name":"\([^"]*\)".*/\1/p')"
# If we can't read project name, just skip strict filtering.
if [[ -n "${PROJECT:-}" ]]; then
  LEFT="$(docker ps -a --filter "label=com.docker.compose.project=$PROJECT" --format '{{.Names}}' | wc -l | tr -d ' ')"
  [[ "$LEFT" == "0" ]] || fail "Leftover containers still present for project '$PROJECT'"
fi

echo
ok "STOP OK"
echo "Logs saved at: $OUT_DIR/${TS}_*"
echo "Safe to reboot/shutdown the host now."

